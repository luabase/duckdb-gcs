#
# This workflow builds extension binaries and uploads them to GCS
# when a new release is created
#
name: Release Extension
on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build:
    name: Build extension binaries
    uses: duckdb/extension-ci-tools/.github/workflows/_extension_distribution.yml@v1.4.4
    with:
      duckdb_version: v1.4.4
      ci_tools_version: v1.4.4
      extension_name: gcs
      exclude_archs: 'wasm_mvp;wasm_eh;wasm_threads;windows_amd64_rtools;windows_amd64_mingw;windows_amd64'

  upload-to-gcs:
    name: Upload to GCS
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.event.release.tag_name }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: ./artifacts

      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -lah ./artifacts/

      - name: Create repository structure
        run: |
          DUCKDB_VERSION="v1.4.4"

          mkdir -p repository/$DUCKDB_VERSION/{linux_amd64,linux_arm64,osx_amd64,osx_arm64}

          # Copy artifacts to the correct DuckDB repository structure
          for arch in linux_amd64 linux_arm64 osx_amd64 osx_arm64; do
            ARTIFACT_DIR="./artifacts/gcs-v1.4.4-extension-$arch"
            if [ -d "$ARTIFACT_DIR" ]; then
              echo "Processing $arch..."
              if [ -f "$ARTIFACT_DIR/gcs.duckdb_extension.gz" ]; then
                cp "$ARTIFACT_DIR/gcs.duckdb_extension.gz" \
                   "repository/$DUCKDB_VERSION/$arch/"
                echo "  Copied gcs.duckdb_extension.gz"
              elif [ -f "$ARTIFACT_DIR/gcs.duckdb_extension" ]; then
                cp "$ARTIFACT_DIR/gcs.duckdb_extension" \
                   "repository/$DUCKDB_VERSION/$arch/"
                echo "  Copied gcs.duckdb_extension"
              fi
            fi
          done

          echo ""
          echo "Repository structure:"
          tree repository/ || find repository/ -type f

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Upload to GCS
        run: |
          BUCKET="${{ secrets.GCS_EXTENSION_BUCKET }}"

          if [ -z "$BUCKET" ]; then
            echo "Error: GCS_EXTENSION_BUCKET secret not set"
            exit 1
          fi

          echo "Uploading to gs://$BUCKET/"

          gsutil -m rsync -r -d repository/ gs://$BUCKET/
          gsutil -m acl ch -r -u AllUsers:R gs://$BUCKET/

      - name: Update release notes
        if: github.event_name == 'release'
        uses: actions/github-script@v7
        with:
          script: |
            const bucket = process.env.GCS_EXTENSION_BUCKET;
            const body = context.payload.release.body + '\n\n' +
              '## Installation\n\n' +
              '```sql\n' +
              `SET custom_extension_repository='https://storage.googleapis.com/${bucket}';\n` +
              'INSTALL gcs;\n' +
              'LOAD gcs;\n' +
              '```\n\n';

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: body
            });
        env:
          GCS_EXTENSION_BUCKET: ${{ secrets.GCS_EXTENSION_BUCKET }}
